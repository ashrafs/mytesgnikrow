<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Firmware: F:/MDBlue/CQ/NghienCuu/USBDongle/USBLPC/Release/Firmware/Nhac.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.2 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>F:/MDBlue/CQ/NghienCuu/USBDongle/USBLPC/Release/Firmware/Nhac.c</h1>  </div>
</div>
<div class="contents">
<a href="_nhac_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include &lt;LPC23xx.H&gt;</span>
<a name="l00002"></a>00002 <span class="preprocessor">#include &quot;<a class="code" href="_nhac_8h.html">Nhac.h</a>&quot;</span>
<a name="l00003"></a>00003 <span class="preprocessor">#include &quot;string.h&quot;</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 
<a name="l00006"></a><a class="code" href="_nhac_8c.html#a916bb50caf839dd34b9cdf0108facecd">00006</a> <span class="preprocessor">#define freq_mult 42950</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span>
<a name="l00008"></a><a class="code" href="_nhac_8c.html#ac263c2c68c72f6827dc42134e0cc1912">00008</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="_nhac_8c.html#ac263c2c68c72f6827dc42134e0cc1912">sine_table256</a>[] =
<a name="l00009"></a>00009 {
<a name="l00010"></a>00010 0x0200,0x020c,0x0219,0x0225,0x0232,0x023e,0x024b,0x0257,0x0264,0x0270,0x027c,0x0289,0x0295,0x02a1,0x02ad,0x02b8,
<a name="l00011"></a>00011 0x02c4,0x02d0,0x02db,0x02e7,0x02f2,0x02fd,0x0308,0x0312,0x031d,0x0327,0x0332,0x033c,0x0345,0x034f,0x0358,0x0362,
<a name="l00012"></a>00012 0x036b,0x0373,0x037c,0x0384,0x038c,0x0394,0x039c,0x03a3,0x03aa,0x03b1,0x03b8,0x03be,0x03c4,0x03ca,0x03cf,0x03d5,
<a name="l00013"></a>00013 0x03d9,0x03de,0x03e2,0x03e6,0x03ea,0x03ee,0x03f1,0x03f4,0x03f6,0x03f8,0x03fa,0x03fc,0x03fd,0x03fe,0x03ff,0x03ff,
<a name="l00014"></a>00014 0x03ff,0x03ff,0x03ff,0x03fe,0x03fd,0x03fb,0x03f9,0x03f7,0x03f5,0x03f2,0x03ef,0x03ec,0x03e8,0x03e4,0x03e0,0x03dc,
<a name="l00015"></a>00015 0x03d7,0x03d2,0x03cd,0x03c7,0x03c1,0x03bb,0x03b4,0x03ae,0x03a7,0x03a0,0x0398,0x0390,0x0388,0x0380,0x0378,0x036f,
<a name="l00016"></a>00016 0x0366,0x035d,0x0354,0x034a,0x0340,0x0337,0x032c,0x0322,0x0318,0x030d,0x0302,0x02f7,0x02ec,0x02e1,0x02d5,0x02ca,
<a name="l00017"></a>00017 0x02be,0x02b3,0x02a7,0x029b,0x028f,0x0282,0x0276,0x026a,0x025e,0x0251,0x0245,0x0238,0x022c,0x021f,0x0212,0x0206,
<a name="l00018"></a>00018 0x01f9,0x01ed,0x01e0,0x01d3,0x01c7,0x01ba,0x01ae,0x01a1,0x0195,0x0189,0x017d,0x0170,0x0164,0x0158,0x014c,0x0141,
<a name="l00019"></a>00019 0x0135,0x012a,0x011e,0x0113,0x0108,0x00fd,0x00f2,0x00e7,0x00dd,0x00d3,0x00c8,0x00bf,0x00b5,0x00ab,0x00a2,0x0099,
<a name="l00020"></a>00020 0x0090,0x0087,0x007f,0x0077,0x006f,0x0067,0x005f,0x0058,0x0051,0x004b,0x0044,0x003e,0x0038,0x0032,0x002d,0x0028,
<a name="l00021"></a>00021 0x0023,0x001f,0x001b,0x0017,0x0013,0x0010,0x000d,0x000a,0x0008,0x0006,0x0004,0x0002,0x0001,0x0000,0x0000,0x0000,
<a name="l00022"></a>00022 0x0000,0x0000,0x0001,0x0002,0x0003,0x0005,0x0007,0x0009,0x000b,0x000e,0x0011,0x0015,0x0019,0x001d,0x0021,0x0026,
<a name="l00023"></a>00023 0x002a,0x0030,0x0035,0x003b,0x0041,0x0047,0x004e,0x0055,0x005c,0x0063,0x006b,0x0073,0x007b,0x0083,0x008c,0x0094,
<a name="l00024"></a>00024 0x009d,0x00a7,0x00b0,0x00ba,0x00c3,0x00cd,0x00d8,0x00e2,0x00ed,0x00f7,0x0102,0x010d,0x0118,0x0124,0x012f,0x013b,
<a name="l00025"></a>00025 0x0147,0x0152,0x015e,0x016a,0x0176,0x0183,0x018f,0x019b,0x01a8,0x01b4,0x01c1,0x01cd,0x01da,0x01e6,0x01f3,0x0200
<a name="l00026"></a>00026 };
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="_nhac_8c.html#a421a3455dc17037fe316bbc9d6a013c4">00028</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="_nhac_8c.html#a421a3455dc17037fe316bbc9d6a013c4">piano_Keys</a>[] =   
<a name="l00029"></a>00029 {
<a name="l00030"></a>00030   27,   29,   31,   33,   35,   37,   39,   41,   44,   46,   49,   52, 0,0,0,0,
<a name="l00031"></a>00031   55,   58,   62,   65,   69,   73,   78,   82,   87,   92,   98,  104, 0,0,0,0, 
<a name="l00032"></a>00032  110,  117,  123,  131,  139,  147,  156,  165,  175,  185,  196,  208, 0,0,0,0, 
<a name="l00033"></a>00033  220,  233,  247,  262,  277,  294,  311,  330,  349,  370,  392,  415, 0,0,0,0, 
<a name="l00034"></a>00034  440,  466,  494,  523,  554,  587,  622,  659,  698,  740,  784,  831, 0,0,0,0, 
<a name="l00035"></a>00035  880,  932,  988, 1046, 1109, 1175, 1244, 1318, 1397, 1480, 1568, 1661, 0,0,0,0, 
<a name="l00036"></a>00036 1760, 1865, 1976, 2093, 2217, 2349, 2489, 2637, 2794, 2960, 3136, 3322, 0,0,0,0, 
<a name="l00037"></a>00037 3520, 3729, 3951, 4186
<a name="l00038"></a>00038 };
<a name="l00039"></a>00039 
<a name="l00040"></a><a class="code" href="_nhac_8c.html#abed34c441df8e252d2412ddd57cd26f1">00040</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_nhac_8c.html#abed34c441df8e252d2412ddd57cd26f1">song_lamb</a>[] = 
<a name="l00041"></a>00041 {
<a name="l00042"></a>00042 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x40,0x40,0x40,0x42,0x45,0x45,
<a name="l00043"></a>00043 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x42,0x40,0x40,0x42,0x40,0x3a,
<a name="l00044"></a>00044 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x40,0x40,0x40,0x42,0x45,0x45,
<a name="l00045"></a>00045 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x42,0x40,0x40,0x42,0x40,0x3a,0x45,
<a name="l00046"></a>00046 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x40,0x40,0x40,0x42,0x45,0x45,0x45,
<a name="l00047"></a>00047 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x42,0x40,0x40,0x42,0x40,0x3a,0x45,
<a name="l00048"></a>00048 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x40,0x40,0x40,0x42,0x45,0x45,0x45,
<a name="l00049"></a>00049 0x42,0x40,0x3a,0x40,0x42,0x42,0x42,0x42,0x40,0x40,0x42,0x40,0x3a,0x4f
<a name="l00050"></a>00050 };
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="_nhac_8c.html#aadcab15d009d8f7995d29df4cd74691d">00052</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_nhac_8c.html#aadcab15d009d8f7995d29df4cd74691d">song_joy</a>[] = 
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054 0x37,0x37,0x38,0x3a,0x3a,0x38,0x37,0x35,0x33,0x33,0x35,0x37,0x37,0x35,0x35,
<a name="l00055"></a>00055 0x37,0x37,0x38,0x3a,0x3a,0x38,0x37,0x35,0x33,0x33,0x35,0x37,0x35,0x33,0x33,
<a name="l00056"></a>00056 0x35,0x35,0x37,0x33,0x35,0x37,0x38,0x37,0x33,0x35,0x37,0x38,0x37,0x35,0x33,0x35,0x2a,0x37,
<a name="l00057"></a>00057 0x37,0x38,0x3a,0x3a,0x38,0x37,0x35,0x33,0x33,0x35,0x37,0x35,0x33,0x33,0x3f
<a name="l00058"></a>00058 };
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a><a class="code" href="_vendor_process_8c.html#a2333a2e9b49f877934d301d0f32176d4">00061</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="_nhac_8c.html#ae239b130ee1b865fb9eaa897ae0592a1">song_custom</a>[512];
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="_vendor_process_8c.html#aed48ca0bcd2162fd4fd495873e2631f5">00063</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#aed48ca0bcd2162fd4fd495873e2631f5">volume</a> = 64;
<a name="l00064"></a><a class="code" href="_nhac_8c.html#a22d803e39cdb6deaf45491adb399c50e">00064</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#a22d803e39cdb6deaf45491adb399c50e">accum</a> = 0;
<a name="l00065"></a><a class="code" href="_nhac_8c.html#aaaebd885ac2fc0f51ac1a470c2946056">00065</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#aaaebd885ac2fc0f51ac1a470c2946056">sample</a>;
<a name="l00066"></a><a class="code" href="_nhac_8c.html#ae0d22272b68e75d19ac0b80c01f806b6">00066</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#ae0d22272b68e75d19ac0b80c01f806b6">freq</a>;
<a name="l00067"></a><a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">00067</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a> = 0;
<a name="l00068"></a><a class="code" href="_nhac_8c.html#accb25237ae393a9f2e9c1271b953e78c">00068</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#accb25237ae393a9f2e9c1271b953e78c">iSizePiano</a> = <span class="keyword">sizeof</span>(<a class="code" href="_nhac_8c.html#a421a3455dc17037fe316bbc9d6a013c4">piano_Keys</a>)/<span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>);
<a name="l00069"></a><a class="code" href="_nhac_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">00069</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = 0;
<a name="l00070"></a><a class="code" href="_nhac_8c.html#a2336afd6eab5e5a75b4adb1a5042bc0c">00070</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * <a class="code" href="_nhac_8c.html#a2336afd6eab5e5a75b4adb1a5042bc0c">song</a>[] = {<a class="code" href="_nhac_8c.html#aadcab15d009d8f7995d29df4cd74691d">song_joy</a>, <a class="code" href="_nhac_8c.html#abed34c441df8e252d2412ddd57cd26f1">song_lamb</a>, <a class="code" href="_nhac_8c.html#ae239b130ee1b865fb9eaa897ae0592a1">song_custom</a>};
<a name="l00071"></a><a class="code" href="_vendor_process_8c.html#a0ba6fe5c23a92e92be4232143448a4bf">00071</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#a0ba6fe5c23a92e92be4232143448a4bf">iSongSize</a>[3];
<a name="l00072"></a>00072  
<a name="l00073"></a><a class="code" href="_nhac_8c.html#a2517d4bd37afe8bdd3e97bb27bfcf4a5">00073</a> <span class="keywordtype">int</span> <a class="code" href="_nhac_8c.html#a2517d4bd37afe8bdd3e97bb27bfcf4a5">iBaiHatA</a> = 0;
<a name="l00074"></a>00074 
<a name="l00075"></a><a class="code" href="_nhac_8c.html#a345ca6d3595f154e9330eace753b0614">00075</a> __irq <span class="keywordtype">void</span> <a class="code" href="_nhac_8c.html#a345ca6d3595f154e9330eace753b0614">ChayNhac</a>()
<a name="l00076"></a>00076 {
<a name="l00077"></a>00077   count++;
<a name="l00078"></a>00078   <span class="keywordflow">if</span>(count == 25000)
<a name="l00079"></a>00079   {
<a name="l00080"></a>00080                 <a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a>++;
<a name="l00081"></a>00081                 count = 0;
<a name="l00082"></a>00082                 <span class="keywordflow">if</span>(<a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a> == iSongSize[iBaiHatA])
<a name="l00083"></a>00083                         <a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a> = 0;
<a name="l00084"></a>00084   }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 
<a name="l00087"></a>00087   <a class="code" href="_nhac_8c.html#ae0d22272b68e75d19ac0b80c01f806b6">freq</a> = <a class="code" href="_nhac_8c.html#a421a3455dc17037fe316bbc9d6a013c4">piano_Keys</a>[song[<a class="code" href="_nhac_8c.html#a2517d4bd37afe8bdd3e97bb27bfcf4a5">iBaiHatA</a>][<a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a>] + 16];
<a name="l00088"></a>00088   <a class="code" href="_nhac_8c.html#a22d803e39cdb6deaf45491adb399c50e">accum</a> += <a class="code" href="_nhac_8c.html#a916bb50caf839dd34b9cdf0108facecd">freq_mult</a> * <a class="code" href="_nhac_8c.html#ae0d22272b68e75d19ac0b80c01f806b6">freq</a>;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090   <a class="code" href="_nhac_8c.html#aaaebd885ac2fc0f51ac1a470c2946056">sample</a> = <a class="code" href="_nhac_8c.html#ac263c2c68c72f6827dc42134e0cc1912">sine_table256</a>[<a class="code" href="_nhac_8c.html#a22d803e39cdb6deaf45491adb399c50e">accum</a> &gt;&gt; 24];
<a name="l00091"></a>00091   <a class="code" href="_nhac_8c.html#aaaebd885ac2fc0f51ac1a470c2946056">sample</a> *= <a class="code" href="_nhac_8c.html#aed48ca0bcd2162fd4fd495873e2631f5">volume</a>;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093   DACR = (<a class="code" href="_nhac_8c.html#aaaebd885ac2fc0f51ac1a470c2946056">sample</a> &amp; 0xFFC0);
<a name="l00094"></a>00094 
<a name="l00095"></a>00095   T0IR        = 1;                      <span class="comment">/* Clear interrupt flag               */</span>
<a name="l00096"></a>00096   VICVectAddr = 0;                      <span class="comment">/* Acknowledge Interrupt              */</span>
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="_nhac_8h.html#a3916502f0893306111830b80a8dfe463">00099</a> <span class="keywordtype">void</span> <a class="code" href="_nhac_8c.html#a805bb5aac1bdfced0062a19e17f65a84">InitSong</a>()
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101         <span class="comment">//Enable DAC</span>
<a name="l00102"></a>00102         PINSEL1 &amp;= (0x03&lt;&lt;20);
<a name="l00103"></a>00103         PINSEL1 |= (0x02&lt;&lt;20);
<a name="l00104"></a>00104           <span class="comment">/* Enable and setup timer interrupt, start timer                            */</span>
<a name="l00105"></a>00105         T0MR0         = 11999 / 100;                       <span class="comment">/* 1msec = 12000-1 at 12.0 MHz */</span>
<a name="l00106"></a>00106         T0MCR         = 3;                           <span class="comment">/* Interrupt and Reset on MR0  */</span>
<a name="l00107"></a>00107         T0TCR         = 0;                           <span class="comment">/* Timer0 disable               */</span>
<a name="l00108"></a>00108         VICVectAddr4  = (<span class="keywordtype">unsigned</span> long)<a class="code" href="_nhac_8c.html#a345ca6d3595f154e9330eace753b0614">ChayNhac</a>;<span class="comment">/* Set Interrupt Vector        */</span>
<a name="l00109"></a>00109         VICVectCntl4  = 15;                          <span class="comment">/* use it for Timer0 Interrupt */</span>
<a name="l00110"></a>00110         VICIntEnable  = (1  &lt;&lt; 4);                   <span class="comment">/* Enable Timer0 Interrupt     */</span>
<a name="l00111"></a>00111 
<a name="l00112"></a>00112         iSongSize[0] = <span class="keyword">sizeof</span>(<a class="code" href="_nhac_8c.html#aadcab15d009d8f7995d29df4cd74691d">song_joy</a>);
<a name="l00113"></a>00113         iSongSize[1] = <span class="keyword">sizeof</span>(<a class="code" href="_nhac_8c.html#abed34c441df8e252d2412ddd57cd26f1">song_lamb</a>);
<a name="l00114"></a>00114         iSongSize[2] = 0;
<a name="l00115"></a>00115          
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="_nhac_8h.html#aa7c6ef70af8d6a223d867d87fde4980e">00118</a> <span class="keywordtype">void</span> <a class="code" href="_nhac_8c.html#aa7c6ef70af8d6a223d867d87fde4980e">NhacOn</a>(<span class="keywordtype">int</span> iBaiHat)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120         iBaiHatA = iBaiHat;
<a name="l00121"></a>00121         T0TCR = 1;
<a name="l00122"></a>00122         count = 0;
<a name="l00123"></a>00123         <a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a> = 0;
<a name="l00124"></a>00124 }
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="_nhac_8h.html#a5b00dad3126cd573e82ea3f7ccdd0a8c">00126</a> <span class="keywordtype">void</span> <a class="code" href="_nhac_8c.html#a5b00dad3126cd573e82ea3f7ccdd0a8c">NhacOff</a>(<span class="keywordtype">void</span>)
<a name="l00127"></a>00127 {
<a name="l00128"></a>00128         T0TCR = 0;
<a name="l00129"></a>00129         count = 0;
<a name="l00130"></a>00130         <a class="code" href="_nhac_8c.html#abedc797afde9589dbd813f82dd6fe286">iPiano</a> = 0;
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a><a class="code" href="_nhac_8h.html#aea0ea691cc36610b05b6a39ef04a7f88">00133</a> <span class="keywordtype">void</span> <a class="code" href="_nhac_8c.html#aea0ea691cc36610b05b6a39ef04a7f88">NhacCustom</a>(<span class="keywordtype">void</span> *p, <span class="keywordtype">int</span> iLen)
<a name="l00134"></a>00134 {
<a name="l00135"></a>00135         memcpy(<a class="code" href="_nhac_8c.html#ae239b130ee1b865fb9eaa897ae0592a1">song_custom</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p, iLen);
<a name="l00136"></a>00136         iSongSize[2] = iLen;
<a name="l00137"></a>00137         <a class="code" href="_nhac_8c.html#aa7c6ef70af8d6a223d867d87fde4980e">NhacOn</a>(2);
<a name="l00138"></a>00138 }
<a name="l00139"></a>00139 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Sun Oct 17 2010 19:19:52 for Firmware by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.2 </small></address>
</body>
</html>
